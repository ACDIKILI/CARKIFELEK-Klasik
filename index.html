<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÇARKIFELEK-Klasik</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { margin: 0; background-color: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Arial Black', sans-serif; color: white; }
        .phone-frame { width: 360px; height: 640px; background-color: #121212; border: 8px solid #222; border-radius: 40px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 15px; }

        /* Giriş Ekranı */
        #login-screen { position: absolute; inset: 0; background: #121212; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 32px; }
        .login-input { background: #1a1a1a; border: 2px solid #fbc02d; color: #fff; padding: 12px; border-radius: 10px; width: 220px; text-align: center; font-size: 18px; margin-bottom: 20px; text-transform: uppercase; }
        .start-btn { background: #fbc02d; color: #000; padding: 15px 40px; border: none; border-radius: 12px; font-weight: 900; cursor: pointer; font-size: 16px; }

        /* Başlık */
        .game-title { font-size: 20px; color: #fbc02d; margin-bottom: 10px; text-shadow: 0 0 10px rgba(251, 192, 45, 0.5); }

        .top-menu { width: 335px; display: flex; flex-direction: column; gap: 8px; z-index: 300; }
        .row { display: flex; gap: 5px; align-items: stretch; justify-content: space-between; }
        
        .header-box { background-color: #fbc02d; border: 2px solid #000; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #000; }
        .mini-board { width: 75px; height: 50px; }
        .mod-box { flex: 1; height: 50px; background-color: #1a1a1a; color: #fff; border: 1px solid #333; }
        
        .box-label { font-size: 10px; font-weight: 900; margin-bottom: 1px; }
        .box-val { font-size: 18px; font-weight: 900; }

        .mod-title { font-size: 12px; font-weight: 900; color: #fbc02d; margin-bottom: 3px; }
        .btn-opt { background: #333; border: 1px solid #fbc02d; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 9px; cursor: pointer; }
        .btn-opt.active { background: #fbc02d; color: #000; box-shadow: 0 0 8px #fbc02d; }

        .selector-row { display: flex; gap: 6px; width: 100%; margin-top: 3px; }
        .tur-box, .oyuncu-box { flex: 1; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 5px; display: flex; flex-direction: column; align-items: center; }

        .cnt-btn { background: #fff; color: #000; border: none; width: 20px; height: 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .cnt-val { font-size: 14px; color: #fff; min-width: 20px; text-align: center; }

        #status-bar { width: 100%; text-align: center; color: #fbc02d; font-size: 12px; margin-top: 8px; text-shadow: 1px 1px 2px #000; }

        /* Çark Alanı */
        .wheel-container { position: relative; width: 300px; height: 300px; margin-top: 25px; }
        #wheel-canvas { width: 100%; height: 100%; border: 8px solid #ff0000; border-radius: 50%; box-sizing: border-box; }
        .pointer-wrapper { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); z-index: 100; transform-origin: top center; }
        .pointer { width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 40px solid #fbc02d; filter: drop-shadow(0 4px 6px #000); }
        #spin-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70px; height: 70px; background: #fbc02d; border: 5px solid #ff0000; border-radius: 50%; color: #000; font-weight: 900; font-size: 14px; cursor: pointer; z-index: 200; display: flex; align-items: center; justify-content: center; }

        /* Dünya Skoru Butonu */
        .world-score-btn { margin-top: 15px; width: 200px; padding: 8px; background: #1a1a1a; border: 1px solid #fbc02d; color: #fbc02d; border-radius: 10px; font-size: 12px; cursor: pointer; text-align: center; transition: 0.3s; }
        .world-score-btn:hover { background: #fbc02d; color: #000; }

        /* Popuplar */
        .gold-btn { position: absolute; left: 50%; transform: translateX(-50%); padding: 10px 20px; background: radial-gradient(circle, #fff2cc, #ffd700, #b8860b); border: 3px solid #fff; border-radius: 12px; color: #000; text-align: center; box-shadow: 0 0 20px #ffd700; z-index: 250; display: none; }
        #result-popup { top: 70%; font-size: 18px; pointer-events: none; }
        #next-player-btn { top: 80%; font-size: 12px; width: 220px; cursor: pointer; animation: pulse 1.5s infinite; }

        /* Final & Dünya Skoru Ekranı */
        #final-screen, #world-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 500; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; border-radius: 40px; }
        .table-row { display: flex; justify-content: space-between; width: 85%; border-bottom: 1px solid #fbc02d; padding: 8px; font-size: 14px; }
        .close-btn { margin-top: 20px; background: #fbc02d; color: #000; padding: 10px 20px; border: none; border-radius: 8px; font-weight: 900; cursor: pointer; }

        @keyframes pulse { 0%, 100% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } }
    </style>

<style>
  .menu-don-btn {
    position: absolute;
    top: 99px;  /* Saatin altına inmesi için 15'ten 55'e çıkardık */
    left: 60px; /* Kenardan biraz daha açtık */
    width: 60px;
    height: 28px;
    background-color: #2ecc71;
    border: 2px solid #000000;
    color: black;
    font-weight: bold;
    font-size: 11px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10000; /* En üstte kalması garantilendi */
    text-decoration: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
}
</style>
    
</head>
<body>

<div class="phone-frame">

<a href="https://acdikili.github.io/ACDgames/" class="menu-don-btn">MENÜ</a>
    
    <div id="login-screen">
        <h2 style="color:#fbc02d; margin-bottom:30px;">HOŞGELDİNİZ</h2>
        <input type="text" id="player-name-input" class="login-input" placeholder="ADINIZI YAZIN" maxlength="12">
        <button class="start-btn" onclick="startGame()">OYUNA BAŞLA</button>
    </div>

    <div class="game-title">ÇARKIFELEK-Klasik</div>

    <div class="top-menu">
        <div class="row">
            <div class="header-box mini-board">
                <span class="box-label">SKOR</span>
                <div id="cur-val" class="box-val">0</div>
            </div>
            <div class="header-box mini-board">
                <span class="box-label">TOPLAM</span>
                <div id="tot-val" class="box-val">0</div>
            </div>
            <div class="mod-box header-box">
                <span class="mod-title">MOD</span>
                <div class="row" style="justify-content: center; gap: 5px;">
                    <div id="opt-single" class="btn-opt active" onclick="setMode('single')">Bireysel</div>
                    <div id="opt-multi" class="btn-opt" onclick="setMode('multi')">Çoklu</div>
                </div>
            </div>
        </div>
        
        <div class="selector-row">
            <div class="oyuncu-box" id="p-select-box" style="visibility: hidden;">
                <span class="mod-title" style="font-size: 10px;">OYUNCU Sayısı</span>
                <div class="row" style="justify-content: center; gap: 3px; margin-top: 2px;">
                    <div class="btn-opt p-cnt" onclick="setPlayerCount(1)">1</div>
                    <div class="btn-opt p-cnt" onclick="setPlayerCount(2)">2</div>
                    <div class="btn-opt p-cnt" onclick="setPlayerCount(3)">3</div>
                    <div class="btn-opt p-cnt" onclick="setPlayerCount(4)">4</div>
                    <div class="btn-opt p-cnt" onclick="setPlayerCount(5)">5</div>
                </div>
            </div>
            <div class="tur-box">
                <span class="mod-title" style="font-size: 10px;">TUR Sayısı</span>
                <div class="row" style="justify-content: center; gap: 8px; margin-top: 2px;">
                    <button class="cnt-btn" onclick="changeTur(-1)">-</button>
                    <span class="cnt-val" id="tur-display">1</span>
                    <button class="cnt-btn" onclick="changeTur(1)">+</button>
                </div>
            </div>
        </div>
    </div>

    <div id="status-bar">Hoş Geldiniz!</div>

    <div class="wheel-container">
        <div class="pointer-wrapper" id="pointer-ui"><div class="pointer"></div></div>
        <canvas id="wheel-canvas"></canvas>
        <div id="spin-btn">BAS</div>
        <div id="result-popup" class="gold-btn"></div>
        <div id="next-player-btn" class="gold-btn">SIRADAKİ OYUNCU</div>
    </div>

    <div class="world-score-btn" onclick="showWorldScore()">DÜNYA SKORU</div>

    <div id="final-screen">
        <h1 style="color:#fbc02d">OYUN BİTTİ</h1>
        <div id="final-stats" style="width:100%"></div>
        <button class="close-btn" onclick="resetGame()">YENİ OYUN</button>
    </div>

    <div id="world-screen">
        <h2 style="color:#fbc02d">TOP 5 DÜNYA</h2>
        <div id="world-stats" style="width:100%"></div>
        <button class="close-btn" onclick="document.getElementById('world-screen').style.display='none'">KAPAT</button>
    </div>
</div>

<script>
    // FIREBASE YAPILANDIRMASI (BlackJACK 4x4 ile aynı)
    const firebaseConfig = {
        apiKey: "AIzaSyBbtvGBl8m1x8thDlsUUutvujedIBCC4PA",
        authDomain: "blackjack-4x4.firebaseapp.com",
        databaseURL: "https://blackjack-4x4-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "blackjack-4x4",
        storageBucket: "blackjack-4x4.appspot.com",
        messagingSenderId: "805180924640",
        appId: "1:805180924640:web:c7da5f8c037b7ff5c26685"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const canvas = document.getElementById('wheel-canvas');
    const ctx = canvas.getContext('2d');
    const btn = document.getElementById('spin-btn');
    const resultPopup = document.getElementById('result-popup');
    const nextBtn = document.getElementById('next-player-btn');
    const statusBar = document.getElementById('status-bar');
    const turDisplay = document.getElementById('tur-display');

    let playerName = "";
    let gameMode = 'single';
    let maxTur = 1;
    let playerCount = 1;
    let currentPlayer = 1;
    let currentSpins = 0;
    let playerScores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    let spinning = false;
    let items = ["İFLAS", "PAS", "PAS", "1", "10", "50", "100", "200", "350", "500", "1000", "5000"];

    function startGame() {
        const input = document.getElementById('player-name-input').value.trim().toUpperCase();
        if (input.length < 2) {
            alert("Lütfen geçerli bir isim girin!");
            return;
        }
        playerName = input;
        document.getElementById('login-screen').style.display = 'none';
        resetGame();
    }

    async function updateFirebaseScore(finalScore) {
        if (gameMode !== 'single') return; // Sadece bireysel skorları kaydediyoruz
        const userRef = database.ref('career_players/' + playerName);
        const snapshot = await userRef.once('value');
        let currentTotal = 0;
        if (snapshot.exists()) {
            currentTotal = snapshot.val().totalScore || 0;
        }
        userRef.set({
            totalScore: currentTotal + finalScore,
            lastUpdate: Date.now()
        });
    }

function showWorldScore() {
        const screen = document.getElementById('world-screen');
        const stats = document.getElementById('world-stats');
        stats.innerHTML = "Bağlanıyor...";
        screen.style.display = 'flex';

        database.ref('career_players').orderByChild('totalScore').limitToLast(5)
            .once('value')
            .then((snapshot) => {
                if (!snapshot.exists()) {
                    stats.innerHTML = "Henüz kayıtlı skor yok!";
                    return;
                }
                let players = [];
                snapshot.forEach((child) => {
                    // Güvenlik: Eğer totalScore yoksa 0 kabul et
                    const data = child.val();
                    const scoreVal = (data && data.totalScore) ? data.totalScore : 0;
                    players.push({ name: child.key, score: scoreVal });
                });
                
                // Büyükten küçüğe sırala
                players.sort((a, b) => b.score - a.score);

                let html = "";
                players.forEach((p, i) => {
                    // Sayı formatlama işlemini güvenli yapıyoruz
                    const formattedScore = Number(p.score).toLocaleString('tr-TR');
                    html += `<div class="table-row"><span>${i + 1}. ${p.name}</span><span>${formattedScore}</span></div>`;
                });
                stats.innerHTML = html;
            })
            .catch((error) => {
                console.error("Firebase Hatası:", error);
                stats.innerHTML = "Bağlantı Hatası: " + error.message;
            });
    }    // Oyun Mantığı Fonksiyonları (Orijinal kod korunarak)
    function changeTur(val) {
        if(spinning) return;
        maxTur = Math.max(1, Math.min(10, maxTur + val));
        turDisplay.innerText = maxTur;
        resetGame();
    }

    function setMode(m) {
        if(spinning) return;
        gameMode = m;
        document.getElementById('opt-single').classList.toggle('active', m==='single');
        document.getElementById('opt-multi').classList.toggle('active', m==='multi');
        document.getElementById('p-select-box').style.visibility = m==='multi' ? 'visible' : 'hidden';
        resetGame();
    }

    function setPlayerCount(n) {
        if(spinning) return;
        playerCount = n;
        document.querySelectorAll('.p-cnt').forEach((b, i) => b.classList.toggle('active', (i+1) === n));
        resetGame();
    }

    function resetGame() {
        currentPlayer = 1; currentSpins = 0;
        playerScores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
        document.getElementById('tot-val').innerText = '0';
        document.getElementById('cur-val').innerText = '0';
        document.getElementById('final-screen').style.display = 'none';
        nextBtn.style.display = 'none';
        updateStatus();
        draw();
    }

    function updateStatus() {
        if(gameMode === 'single') statusBar.innerText = `${playerName} | Hak: ${maxTur - currentSpins}/${maxTur}`;
        else statusBar.innerText = `Oyuncu ${currentPlayer} | Hak: ${maxTur - currentSpins}/${maxTur}`;
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTick() { 
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); 
        const gain = audioCtx.createGain(); 
        osc.frequency.setValueAtTime(1200, audioCtx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.04); 
        osc.connect(gain); gain.connect(audioCtx.destination); 
        osc.start(); osc.stop(audioCtx.currentTime + 0.04); 
    }

    function draw() {
        const r = 250; canvas.width = 500; canvas.height = 500;
        const arc = (Math.PI * 2) / items.length;
        items.forEach((text, i) => {
            const angle = i * arc;
            ctx.beginPath();
            if (text === "İFLAS") ctx.fillStyle = "#000";
            else if (text === "PAS") ctx.fillStyle = "#808080";
            else if (parseInt(text) < 100) ctx.fillStyle = "#fbc02d";
            else if (parseInt(text) < 1000) ctx.fillStyle = "#2E7D32";
            else if (text === "1000") ctx.fillStyle = "#1565C0";
            else ctx.fillStyle = "#C62828";
            ctx.moveTo(r, r); ctx.arc(r, r, r, angle, angle + arc); ctx.fill();
            ctx.strokeStyle = "#000"; ctx.lineWidth = 4; ctx.stroke();
            ctx.save(); ctx.translate(r, r); ctx.rotate(angle);
            ctx.beginPath(); ctx.arc(r - 5, 0, 6, 0, Math.PI * 2); ctx.fillStyle = "#000"; ctx.fill();
            ctx.restore();
            ctx.save(); ctx.translate(r, r); ctx.rotate(angle + arc / 2);
            ctx.textAlign = "right"; ctx.fillStyle = (text==="İFLAS"||text==="PAS"||parseInt(text)>=100) ? "#fff":"#000";
            ctx.font = "bold 30px Arial"; ctx.fillText(text, r - 45, 10); ctx.restore();
        });
    }

    let currentRotation = 0;
    btn.addEventListener('click', () => {
        if (spinning) return;
        if(nextBtn.style.display === 'block') {
            nextBtn.style.display = 'none';
            currentSpins = 0;
            document.getElementById('cur-val').innerText = '0';
            updateStatus();
            return;
        }
        spinning = true;
        resultPopup.style.display = "none";
        if (audioCtx.state === 'suspended') audioCtx.resume();
        items.sort(() => Math.random() - 0.5);
        draw();

        const duration = 5000 + Math.random() * 2000;
        const extraSpins = (10 + Math.random() * 5) * 360;
        const startTime = performance.now();
        let lastTickAngle = 0;

        function animate(time) {
            const elapsed = time - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easing = 1 - Math.pow(1 - progress, 3);
            const currentAngle = currentRotation + (extraSpins * easing);
            canvas.style.transform = `rotate(${currentAngle % 360}deg)`;

            if (Math.abs(currentAngle - lastTickAngle) >= (360/items.length)) {
                playTick(); lastTickAngle = currentAngle;
                document.getElementById('pointer-ui').style.transform = "translateX(-50%) rotate(-15deg)";
                setTimeout(() => document.getElementById('pointer-ui').style.transform = "translateX(-50%) rotate(0deg)", 50);
            }
            if (progress < 1) requestAnimationFrame(animate);
            else { 
                spinning = false; 
                currentRotation = currentAngle; 
                const finalIdx = Math.floor((360 - (currentAngle % 360) + 270) % 360 / (360 / items.length));
                handleResult(items[finalIdx % items.length]); 
            }
        }
        requestAnimationFrame(animate);
    });

    function handleResult(res) {
        if (res === "İFLAS") playerScores[currentPlayer] = 0;
        else if (res !== "PAS") playerScores[currentPlayer] += parseInt(res);
        
        document.getElementById('cur-val').innerText = res;
        document.getElementById('tot-val').innerText = playerScores[currentPlayer];
        resultPopup.innerText = res; 
        resultPopup.style.display = "block";
        
        currentSpins++;
        
        if (currentSpins >= maxTur) {
            if (gameMode === 'multi' && currentPlayer < playerCount) {
                setTimeout(() => { 
                    nextBtn.innerText = `Sıradaki: Oyuncu ${currentPlayer + 1} (BAS'a Bas)`; 
                    nextBtn.style.display = 'block'; 
                    currentPlayer++; 
                }, 1500);
            } else { 
                setTimeout(() => { 
                    // Firebase'e sadece bireysel modda toplam skoru kaydet
                    if(gameMode === 'single') {
                        updateFirebaseScore(playerScores[1]);
                    }

                    document.getElementById('final-screen').style.display = "flex"; 
                    let s=""; 
                    for(let i=1; i<=(gameMode==='single'?1:playerCount); i++) {
                        s+=`<div class='table-row'><span>${gameMode==='single'?playerName:('Oyuncu '+i)}:</span><span>${playerScores[i]} Puan</span></div>`;
                    }
                    s += `<div style="height:10px"></div><div class='table-row' style='color:#fbc02d'><span>DÜNYA SKORU GÜNCELLENDİ!</span></div>`;
                    document.getElementById('final-stats').innerHTML=s; 
                }, 1500); 
            }
        }
        updateStatus();
    }

    draw(); updateStatus();
</script>
</body>
</html>



